using System;
using System.Collections.Generic;
using Microsoft.VisualStudio.TestTools.UnitTesting;

namespace AlgoTest.AOC2023;

[TestClass]
public class Day21
{
    [TestMethod]
    public void Test()
    {
        var grid = data.Split('\n', StringSplitOptions.TrimEntries);

        var start = FindStartPosition(grid);

        const int maxSteps = 64;

        Console.WriteLine(FindCount(grid, start, maxSteps));
    }
    
    [TestMethod]
    public void Test2()
    {
        var grid = data.Split('\n', StringSplitOptions.TrimEntries);

        var start = FindStartPosition(grid);
        (long h, long w) = (grid.Length, grid[0].Length);
        const long maxSteps = 26501365;

        Console.WriteLine($"Height and Width : ({h}, {w})");
        Console.WriteLine($"Start {start}");


        var c1 = FindCount(grid, start, 0 * w + maxSteps % w, true);
        var c2 = FindCount(grid, start, 1 * w + maxSteps % w, true);
        var c3 = FindCount(grid, start, 2 * w + maxSteps % w, true);
        var c4 = FindCount(grid, start, 3 * w + maxSteps % w, true);
        var c5 = FindCount(grid, start, 4 * w + maxSteps % w, true);
        Console.WriteLine($"{c1} {c2} {c3} {c4} {c5}");

        var firstDiff1 = c2 - c1;
        var firstDiff2 = c3 - c2;
        var firstDiff3 = c4 - c3;
        var firstDiff4 = c5 - c4;
        Console.WriteLine($"First Diffs: {firstDiff1} {firstDiff2} {firstDiff3} {firstDiff4}");

        var secondDiff1 = firstDiff2 - firstDiff1;
        var secondDiff2 = firstDiff3 - firstDiff2;
        var secondDiff3 = firstDiff4 - firstDiff3;
        Console.WriteLine($"Second Diffs : {secondDiff1} == {secondDiff2} == {secondDiff3}");

        var a = secondDiff1 / 2;
        var b = firstDiff1 - (3 * a);
        var c = c1 - a - b;
        Console.WriteLine($"a={a} b={b} c={c}");

        Func<long, long> f = (long n) => a * n * n + b * n + c;
        
        Console.WriteLine(f((long)Math.Ceiling((double)maxSteps / w)));
    }
    
    private static long FindCount(
        string[] grid,
        (int, int) start,
        long maxSteps,
        bool infinite = false
    )
    {
        var (startR, startC) = start;

        var rCount = grid.Length;
        var cCount = grid[0].Length;

        HashSet<(int, int)> visited = new(){(startR, startC)};
        for (long step = 0; step < maxSteps; step++)
        {
            HashSet<(int, int)> next = new();
            foreach (var pos in visited)
            {
                foreach (var m in PossibleMoves)
                {
                    var p = (pos.Item1 + m.Item1, pos.Item2 + m.Item2);
                    var lookupP = infinite ? (Modulo(p.Item1, rCount), Modulo(p.Item2, cCount)) : p;

                    if (
                        (!infinite && IsOutsideGrid(lookupP, grid))
                        || grid[lookupP.Item1][lookupP.Item2] is '#'
                    )
                    {
                        continue;
                    }

                    next.Add(p);
                }
            }

            visited = next;
        }

        return visited.Count;
    }

    private static int Modulo(int a, int b) => a % b < 0 ? a % b + b : a % b;

    private static (int, int) FindStartPosition(string[] grid)
    {
        (int startR, int startC) = (0, 0);

        for (int r = 0; r < grid.Length; r++)
        {
            var c = grid[r].IndexOf('S');
            if (c != -1)
            {
                (startR, startC) = (r, c);
                break;
            }
        }

        return (startR, startC);
    }

    private static bool IsOutsideGrid((int, int) pos, string[] grid)
    {
        var (r, c) = pos;
        return r < 0 || r >= grid.Length || c < 0 || c >= grid[0].Length;
    }
    
    private static readonly List<(int,int)> PossibleMoves = new(){(1, 0), (-1, 0), (0, 1), (0, -1)};
    
    private string data = """
                            ...................................................................................................................................
                            ....#...........#...#...........................#....................................#....##........#..........#.....#.............
                            ..........#...##..#.....................#.#.#..................................#.#..#..#............#........#.....................
                            ....#................##.....................#..........#........................##.#...#..#......#...#......#....#.................
                            .#..#.................................#.................................................#..#............#..#.##.#.#.........###....
                            ..#...#.#.......#......#...........#................#............................................##.........#...#...#....##........
                            ................#.#..........#..........##..#..............................#...#................#.#......##.......#............#...
                            ........#.#...#..#.##.#.....#......................#.#.............................#....#......#.#.#...#........#..................
                            .#...##.........#..#..........#....#.....#...........................................#........#.......#.......#...........#........
                            .........##............#.......#..#.......#...#.#.....................................#..###.......###.........#.....#...#.....#...
                            .#..#.......#....#..#............#.....#............................#................#.........##...................#..#.#..#......
                            .#.................###..#...........#.........#................##....#...........#...........#.....................................
                            .....##.........#..#..........#.....##....#................#..##...................#......#.....#..#.....#.#.......................
                            ..........#......#..............#..#...#..............................................#...........#.#........#............#.#......
                            ...........#.#......#.....#.#.....#.....................#...........#....#.............#.#......##...#......#.....##...............
                            ..............#...##....##.....#......#...............#.#.#...#.....#.................#.#.............#...............#....#.#.#...
                            .##.#........#.........#.#.#....#....#.......#.........................#...............#..........#.....##....#...............##...
                            .....#.......##............#.........#....#.................#.................#.......#...............#......................#...#.
                            ...............#..........................#........#..#.......##..#....#..#...#................#....#...#.........#.#.#..#......#..
                            ..........#..#..#..#.##.........#......#.......................#.....#.........#......................#...#.##......#....#....#....
                            ....#.........#......#................#..#.............##.#......................#...........#..#.............#....##........#.....
                            .............#...#.................#...#...........#...#.#......#......#.......................#.................#....#.#....##....
                            .......#.#.....#..........#.....#.##............#.#......#........#...#.......##................#................#.......#.........
                            .#.....................#..#.....#.#...........................#..................#...........#....#......##..............#.....##..
                            .....#..............#....#.....................#..##...........................#..................#...................#.........#..
                            ....#..#.##........#.....#.........................................#......#.......................#....#....#...#...#....#...#.....
                            ...................#....###....#............#..#.............#.#......#........##.................#...#....#.....#.##..............
                            ......#...#........#....#.....#................#...............................#........................##..#..#......##........#..
                            .#.....#..........#....#........#................#....#...#..#..#.............#..#..........................#.........#..........#.
                            .......................#.....#.................#.....................................##.#.........#..................#.....#....#..
                            .#..................#....#....#...........#....#...#..#..#.............#....#....#####....#.........#.......#..#..###...........##.
                            ....#.......#.#............#.#.................##.............#.#.#....#...##...#...#...............##.###...........##......#...#.
                            .....#...#...#.........#.....................#....##..#........#......#.................#.#...................#.#..............#...
                            ........##.....##.........#.#......................................#..........#.....#.#.....#.#..............#..........#..........
                            ........#....#.........#..#..............##.....#.....#.....#............#............#....................#.....#.....#.......#.#.
                            ......##...........................#............#.....#.#..............#...........#.......................................#.......
                            .#.......#...#....#...............................#....##...#..........#.##........##....#................##...........#...........
                            .#.##.........#.................#................#.#..#.#................#.................................#.......................
                            .#..#..............#.##.........##.....................................#.....#........#.#..##..#..##............#..........#...#...
                            ....#.##...........###.........#.....#........##...#...#......##..#...............#.#.......#...#.#..........#..........#..........
                            ..........#.....#.....................#..##..#.#.##.............#..............#.............#......##...........##....#.......#...
                            .....#.......#..................#..........#.......#........#..........##.....#....#...........................#..............#....
                            .........#.......................##...............#......#.....#...#..........#.#..#...................#...................#.##....
                            .........#..............................##......##...#..............#...##......#..............#.....#.......................#.....
                            ....#............................#...#..#.#.......#.............#...............#.....#..................#........#.........#......
                            ..#.....................##........#......#...#....#.#..............#...............#.........#...#....#.###..........#....#..#..#..
                            ...........#...#.................#.........#..##.#......#.#.................#..#.......#..............................#..........#.
                            .....#.#.................##.#.....#....#.........#.....#..#...#.......##..#................................##.................#....
                            .......#..............#.......#................#.......#..............##.....#...#...#.............................................
                            .#......#.................#......#.......#.........#...........#...#.......#...#...#......#.......#.#.....#...#..................#.
                            ..#...#...............#.......#.#...................#.....#.#........................#......#....##.#..............................
                            ...##....#......................................#......##.......................#..#...##...............................#...#......
                            .##..........................................#...............#.......................##.....#...............#.#....................
                            ..#..#...................................##..#.....................................#........##.....#....###......##............#...
                            ...#............#.......#.........#..#.....#.......#.........##........................#...#...#.#..#....#.#.##....#........##.#...
                            .....#...........#.#....#..............#.....#..............#.................#.......#....#................#....#.................
                            ....#............#......#.............#....#.#...##..#....#.#...#......#.......#...........#..........#.......#....................
                            ...##..............#......#...#........#.........#...#....#............#..#..........#.#..#.......#...#.........#.....#............
                            .............#.##.........#...#....##.#...#...........##...........##..#....#.......#............##................#...............
                            .............#..##...#.#.#.#..#.#............#...#......#...#.....#.........###....#..............#............#.#.....#........##.
                            ..........#.................#.....#.........#.#......#.#...........#.......#...............#..#..........#........#.....##.......#.
                            ....................#................#......................#..............#........##...#......#....#...........#.#....#..........
                            ..................#.....#.#.#....#...#..........................#...#...........................................#....#...#.........
                            ......#..........#.#..#........#.....#.......................#.........#......#.............#..............................#.......
                            ...........##....#..#........#...#............#...............#.#.##.#.#.#............#...#........#.....#..#.#...#......#.........
                            .................................................................S.................................................................
                            .....#........#......#...........#..#............#..............#........###........#......#............#.....#....#...#...........
                            ..................................#..#................#........#.........#...#.#.......#..#..........#...........#......#.#........
                            ............#.........###........#........##........................#...#.....#......#..##..#.......#..###..............#..........
                            ..........#..............................................#...............#..............#............#.#...#..............#........
                            ...........#...#..#...##...........#............#.....#.#..#..#........#..#...............#...............#.....#.....#.##.........
                            .....................#....#..........#..#..................#..#.........#......#..................#.................#..#...........
                            ............#....#.#...............#.....#..........##..............#...#.#....#....#......#.......................................
                            .#...........#............#..#..#....................................#.......#......#.....#....#.............#.....................
                            ..#.#...........#.............#...............#...#.....#.......#.............#.........#.#.........#..........#...................
                            ..............#................##.#.#.#.#......#...#...........#....#.#.....................#...........##.#..#.............#.##...
                            ...#...............#..........................##........#..#.....................#...........#...#...#.#...#......##...............
                            ........#..........#...#..........#...#.....#............#.......................#.#..........#...#..........................##....
                            .......#..............#.............#.......##.#..#...#........#.....#..#.....#....#............................#........#...#.....
                            ..........#.............#...........#........#..#...###....#..........#...#....#..............#.##.............#.........#...#.##..
                            .........................#.#..........#.....#.........##.#..............#.....##.........#.##.....#.....#..........................
                            ....#....#.................#..........#...#.....##.#...#....#.........##.....#.##.............................................#....
                            ...#....#.#............#...........................#......................#..#..#...###............#...#...........................
                            ..............#............#................#...#.#..........................#....................#...#.#............#.....#.....#.
                            .......#.......#........#..................#.#....#...#..............#......#...............#.......##...#.................#.......
                            .....#.#..............................#.#...#..................#...........#.##................#...................#..#.#..........
                            .....#..........#..........#.#.....#.........#....................#..#..#.......#......................##................#.....#...
                            ....#..................................#....#........#.........#..........#...#.........#..#..........#.............#.......#..#...
                            .#.................#........#..#.#......#..#.#.....#..#.........#......#......#.#........#.....#.#....#............#.......#.##....
                            ...............#................#..........#...#.#...#...#....#.#..#...........#....#..............................#............#..
                            .........#...........#.........#................................#...#..#........................................#....#.#...........
                            ...#..................#...........#........#................#.#....#............#...#........................#...#.................
                            .#..............##.....#.......#......#..............#..........................#.#...........#............#...........#....#......
                            ........#....#......................#................#........#...................#.........................#.#....#............##.
                            ...........#.........#.#...........##......##..#.#..#.....................#.#......#...........#.............#.....................
                            ...........#...##.........#...........................#......##.......#......#...............#.#...........#.##...#..#..#..#..#....
                            ....#...##..#.#..#.#....#...........#.........#.....#.........#.#.....................#..................#..........#........##.#..
                            .....##....#..........#.#...........#....#..............#................#.......#....................##......#....................
                            .#..#..#........#....................#..#.#....#........##.....##.#......#.....#......#....#.....................#......#..###.#...
                            .........#...#...............#.........#..#............#.#....#.........#.............#...#.................#..............##......
                            ...##........#.#.#.....##..#........................#....#...#...........#..........#.#............#.#...#.............#...........
                            ...##..............#......##.................#...........#..........#..............##......................#...#.....#....#..#.....
                            ........#........#........#.................###.................................#....................##.#.#...#...............#..#.
                            .......#.......................................#..........#..........................#.#............#.........#..#..##.............
                            .........#.........................#................#................#...#.......#..#..#.......#.........###.......................
                            ........#.....#......###.#...............................#........#....#.....#..##.............................#..#...#........#...
                            ...........#.#....#..........#.#...#..........####.#......####.#....................#.............................#................
                            ...##.............#..#........#................#......................#...#......#..#........#......#..................#...#.#...#.
                            .#........#.......#.......#.......#................#........#..#.....#...........#.........#.......#.#........#........##...#..#...
                            ..........#.......#............#.........................#.................#....#...........##.........#...#................#....#.
                            .........##.#.....#...#..##..............................#..................................##......##..#..........................
                            ........#......###..#....#....#.##....#..............#........#...#.........................................#........#...........#.
                            .......#.....#.#..#....#..........#...#.#..#....................#........#..............#......#..#..#....#............#.......#...
                            ...........#.##..#......##.#...............#.............#.##.............#.......................#...........##...................
                            .###.....................#.#..........................................#.#.................#........#............#.........#........
                            .....#....#......#..#.....#............#..............................................#....##.......#........#..#..........#.......
                            .......#......................................................##...#.................#.......................##....................
                            ......#.#....#...#...............#.#...#..#...............##......#..#............#.....#.......#.................#..##..#.#.....#.
                            ............#........#..#.........#....#......##.#........#....#..#...........................#...............#............##......
                            .....#....#.##.......................#....................#.#.................................................#....##....#...#.....
                            ..............###..#.....#........#.........##.#...........#.#.#...#.............#......#...............#.##...........##..........
                            ........................#..#.........#.....#.......#.........#.....#................#.#.#..........................#.#......##.....
                            .......##........#......#........#.##.#.#........#......................................#......#...#.#...#.......#..#.....#........
                            .#.....####..........#......#.......................#.............#...........#.....#.......#.#.....................#..............
                            ...#.....#...##.............#...............#..##..................#................#..........#...#........#.......#..............
                            .#.........#..#...#.#....#....#.......#...........#...............#...............#...#........#..........................#........
                            ...............#....#........###.......#....................................#.................#...........#.........#..#...........
                            .......#......#..#.....#.........#.........#............#.......................#..#........#...#..#.....#.......#.............#...
                            ........................#.............#........#..........#.................#......##.#..#...#.............#...........#...#....#..
                            ....#.....#....#......#...#...#...................#..##.................#..........##.##...............#..........##...............
                            ...................................................................................................................................
                          """;
}